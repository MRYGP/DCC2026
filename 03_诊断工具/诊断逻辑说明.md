# 🔄 诊断逻辑说明 v1.0

**版本**：v1.0  
**创建日期**：2025-12-06  
**适用场景**：贷查查MVP - 完整业务逻辑  
**依赖文档**：诊断问卷v1.0、匹配算法说明、体检报告模板

---

## 📌 核心评估框架

贷查查诊断体系基于以下三层评估框架：

1. **贷款体质六宫格**（整体体质地图）
   - 流水体质、票税体质、征信体质、资产体质、资质体质、行业体质
   - 详见：系统指令-贷查查专用.md

2. **银行放款五问**（决策核心问题）
   - 做什么？用途？产值？负债？利润？
   - 详见：系统指令-贷查查专用.md

3. **银行审核八大维度**（审批实操维度）⭐新增
   - 实体经营、负债结构、流水体质、社保信号、资质荣誉、利润留存、法人风险、生意故事
   - 详见：[银行审核八大维度-v1.0.md](./银行审核八大维度-v1.0.md)

**使用说明**：
- 诊断问卷设计：将八大维度问题嵌入问卷
- 体检报告生成：输出"银行视角体质小结"
- 方案推荐：根据薄弱维度推荐对应改造方案

---

## 一、整体业务流程

### 1.1 完整流程图

```
┌─────────────────────────────────────────────────────────────────┐
│  用户入口：贷查查首页                                        │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 1：问卷填写（3-5分钟）                                     │
│  • 15道题，4个模块                                               │
│  • 智能跳转（Q6/Q10/Q15有条件显示）                             │
│  • 实时验证（必填项检查）                                        │
│  • 进度提示（第X步，共4步）                                      │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 2：数据标准化（<1秒）                                      │
│  • 枚举值→数值转换（如"100w_to_300w" → min:1000000, max:3000000）│
│  • 数据完整性检查                                                │
│  • 构建标准化答案对象                                            │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 3：产品匹配（<1秒）                                        │
│  • 加载产品库（15个产品）                                        │
│  • 逐个检查准入条件                                              │
│  • 筛选出符合条件的产品                                          │
│  • 计算每个产品的可贷额度                                        │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 4：产品排序（<1秒）                                        │
│  • 多维度评分（额度40% + 利率30% + 速度20% + 担保10%）           │
│  • 按综合评分排序                                                │
│  • 标记"推荐产品"（Top 3）                                       │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 5：缺口识别（<1秒）                                        │
│  • 对比所有产品的准入条件                                        │
│  • 识别"差一点就能申请"的产品                                    │
│  • 计算补齐后的额度提升                                          │
│  • 按潜在提升排序                                                │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 6：方案匹配（<1秒）                                        │
│  • 根据缺口类型匹配改造方案                                      │
│  • 计算ROI（预期提升 / 投入成本）                                │
│  • 按ROI、周期、成本综合排序                                     │
│  • 选择Top 3方案                                                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 7：报告生成（<1秒）                                        │
│  • 组装报告数据结构                                              │
│  • 生成诊断建议文案                                              │
│  • 渲染报告页面                                                  │
│  • 提供PDF导出选项                                               │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  用户出口：体检报告页面                                          │
│  • 下载PDF报告                                                   │
│  • 预约咨询                                                      │
│  • 分享报告                                                      │
└─────────────────────────────────────────────────────────────────┘
```

**总耗时**：3-5分钟（问卷填写）+ <5秒（后台计算）

---

### 1.2 系统交互图

```
┌──────────┐         ┌──────────┐         ┌──────────┐
│  前端页面 │ ←─────→ │  后端API  │ ←─────→ │  数据库   │
└──────────┘         └──────────┘         └──────────┘
      ↓                     ↓                     ↓
  用户交互            业务逻辑处理           数据持久化
  • 问卷填写          • 产品筛选             • 产品库
  • 报告展示          • 额度计算             • 方案库
  • PDF导出           • 方案推荐             • 诊断记录
```

---

## 二、数据流转详解

### 2.1 问卷答案 → 标准化数据

**输入**：原始问卷答案（枚举值）

```json
{
  "company_age": "3_to_5",
  "annual_invoice_amount_last_year": "500w_to_1000w",
  "invoice_amount_ytd": "500w_to_1000w",
  "has_property": true,
  "property_value": "300w_to_500w"
}
```

**转换逻辑**：

```javascript
function normalizeAnswers(rawAnswers) {
  const invoiceLastYear = getNumericValue(rawAnswers.annual_invoice_amount_last_year, "amount");
  const invoiceYtd = getNumericValue(rawAnswers.invoice_amount_ytd, "amount");
  const taxLastYear = getNumericValue(rawAnswers.annual_tax_amount_last_year, "tax");
  const taxYtd = getNumericValue(rawAnswers.tax_amount_ytd, "tax");
  
  return {
    // 保留原始枚举值
    ...rawAnswers,
    // 兼容旧字段访问（使用去年数据为代表）
    annual_invoice_amount: rawAnswers.annual_invoice_amount_last_year || rawAnswers.invoice_amount_ytd || "no_invoice",
    annual_tax_amount: rawAnswers.annual_tax_amount_last_year || rawAnswers.tax_amount_ytd || "less_than_1w",
    
    // 增加数值字段（用于计算）
    company_age_years: getNumericValue(rawAnswers.company_age, "years"),
    
    annual_invoice_amount_min: Math.max(invoiceLastYear, invoiceYtd),
    annual_invoice_amount_max: Math.max(invoiceLastYear, invoiceYtd) * 1.5,
    
    annual_tax_amount_min: Math.max(taxLastYear, taxYtd),
    annual_tax_amount_max: Math.max(taxLastYear, taxYtd) * 1.5,
    
    property_value_min: rawAnswers.has_property ? 
      getNumericValue(rawAnswers.property_value, "amount") : 0,
    property_value_max: rawAnswers.has_property ? 
      getNumericValue(rawAnswers.property_value, "amount") * 1.5 : 0
  };
}
```

**输出**：标准化数据

```json
{
  "company_age": "3_to_5",
  "company_age_years": 4,
  "annual_invoice_amount_last_year": "500w_to_1000w",
  "invoice_amount_ytd": "500w_to_1000w",
  "annual_invoice_amount": "500w_to_1000w",
  "annual_invoice_amount_min": 7500000,
  "annual_invoice_amount_max": 11250000,
  "has_property": true,
  "property_value": "300w_to_500w",
  "property_value_min": 4000000,
  "property_value_max": 6000000
}
```

---

### 2.2 标准化数据 → 产品匹配结果

**输入**：标准化数据 + 产品库

**处理流程**：

```javascript
function matchProducts(normalizedAnswers, productDatabase) {
  const matchedProducts = [];
  
  for (let product of productDatabase) {
    // 1. 检查准入条件
    const eligible = checkEligibility(product, normalizedAnswers);
    
    if (eligible) {
      // 2. 计算额度
      const amount = calculateAmount(product, normalizedAnswers);
      
      // 3. 计算利率（取中值）
      const rate_avg = (product.rate_min + product.rate_max) / 2;
      
      matchedProducts.push({
        product_id: product.id,
        product_name: product.name,
        product_type: product.type,
        bank_name: product.bank_name,
        amount: amount,
        rate_min: product.rate_min,
        rate_max: product.rate_max,
        rate_avg: rate_avg,
        duration: product.duration,
        speed: product.speed,
        guarantee_type: product.guarantee_type
      });
    }
  }
  
  return matchedProducts;
}
```

**输出**：匹配产品列表

```json
[
  {
    "product_id": "P001",
    "product_name": "招商银行-经营抵押贷",
    "product_type": "抵押贷",
    "bank_name": "招商银行",
    "amount": 5250000,
    "rate_min": 0.0298,
    "rate_max": 0.0600,
    "rate_avg": 0.0449,
    "duration": "最长10年",
    "speed": "1-2周",
    "guarantee_type": "抵押"
  },
  {
    "product_id": "P002",
    "product_name": "平安银行-发票云贷",
    "amount": 1125000,
    "rate_min": 0.04,
    "rate_max": 0.12,
    "rate_avg": 0.08
  }
]
```

---

### 2.3 产品匹配结果 → 推荐产品

**输入**：匹配产品列表

**处理流程**：

```javascript
function recommendProducts(matchedProducts) {
  // 1. 多维度评分
  const maxAmount = Math.max(...matchedProducts.map(p => p.amount));
  const maxRate = Math.max(...matchedProducts.map(p => p.rate_avg));
  
  const scoredProducts = matchedProducts.map(product => {
    const amountScore = (product.amount / maxAmount) * 40;
    const rateScore = (1 - product.rate_avg / maxRate) * 30;
    const speedScore = getSpeedScore(product.speed) * 20;
    const guaranteeScore = getGuaranteeScore(product.guarantee_type) * 10;
    
    const totalScore = amountScore + rateScore + speedScore + guaranteeScore;
    
    return {
      ...product,
      score: totalScore
    };
  });
  
  // 2. 排序
  scoredProducts.sort((a, b) => b.score - a.score);
  
  // 3. 标记推荐
  return scoredProducts.map((p, index) => ({
    ...p,
    rank: index + 1,
    is_recommended: index < 3
  }));
}
```

**输出**：推荐产品列表

```json
[
  {
    "product_name": "招商银行-经营抵押贷",
    "amount": 5250000,
    "score": 92.5,
    "rank": 1,
    "is_recommended": true
  },
  {
    "product_name": "平安银行-发票云贷",
    "amount": 1125000,
    "score": 78.3,
    "rank": 2,
    "is_recommended": true
  }
]
```

---

### 2.4 标准化数据 → 缺口列表

**输入**：标准化数据 + 产品库（所有产品，包括不匹配的）

**处理流程**：

```javascript
function detectGaps(normalizedAnswers, allProducts) {
  const gaps = [];
  
  for (let product of allProducts) {
    const checkResult = checkProductEligibility(product, normalizedAnswers);
    
    // 只关注"接近但未达到"的产品
    if (!checkResult.eligible && checkResult.nearMiss) {
      gaps.push({
        product_id: product.id,
        product_name: product.name,
        gap_type: checkResult.gap_type,
        gap_description: getGapDescription(checkResult.gap_type),
        current_value: checkResult.current_value,
        target_value: checkResult.target_value,
        gap_value: checkResult.gap_value,
        potential_amount: estimateAmountAfterFix(product, checkResult.target_value)
      });
    }
  }
  
  // 按潜在额度提升排序
  gaps.sort((a, b) => b.potential_amount - a.potential_amount);
  
  return gaps.slice(0, 3); // 最多返回3个缺口
}
```

**输出**：缺口列表

```json
[
  {
    "product_name": "交通银行-发票贷",
    "gap_type": "invoice_insufficient",
    "gap_description": "年开票额不足",
    "current_value": 7500000,
    "target_value": 10000000,
    "gap_value": 2500000,
    "potential_amount": 1800000
  }
]
```

---

### 2.5 缺口列表 → 推荐方案

**输入**：缺口列表 + 方案库

**处理流程**：

```javascript
function recommendSchemes(gaps, schemeDatabase) {
  const schemes = gaps.map(gap => {
    // 1. 根据缺口类型匹配方案
    const scheme = mapGapToScheme(gap.gap_type, schemeDatabase);
    
    if (!scheme) return null;
    
    // 2. 计算ROI
    const expectedIncrease = gap.potential_amount;
    const cost = scheme.cost;
    const roi = ((expectedIncrease / cost) * 100).toFixed(2) + "%";
    
    // 3. 计算回本周期（假设年化利息5%）
    const paybackMonths = Math.ceil(cost / (expectedIncrease * 0.05 / 12));
    
    return {
      scheme_id: scheme.id,
      scheme_name: scheme.name,
      scheme_type: scheme.type,
      gap_type: gap.gap_type,
      gap_description: gap.gap_description,
      cost: cost,
      duration: scheme.duration,
      duration_months: scheme.duration_months,
      expected_increase: expectedIncrease,
      roi: roi,
      payback_months: paybackMonths,
      steps: scheme.steps
    };
  }).filter(s => s !== null);
  
  // 按ROI、周期、成本综合排序
  return rankSchemes(schemes);
}
```

**输出**：推荐方案列表

```json
[
  {
    "scheme_id": "S001",
    "scheme_name": "开票提升术",
    "gap_description": "年开票额不足",
    "cost": 110000,
    "duration": "4-7个月",
    "duration_months": 5.5,
    "expected_increase": 1800000,
    "roi": "1636.36%",
    "payback_months": 1,
    "steps": ["签约启动（1周）", "执行H业务（3-6月）", "申请贷款（2-4周）"]
  }
]
```

---

### 2.6 所有数据 → 体检报告

**输入**：
- 推荐产品列表
- 缺口列表
- 推荐方案列表
- 原始问卷答案

**处理流程**：

```javascript
function generateReport(data) {
  const {
    normalizedAnswers,
    recommendedProducts,
    gaps,
    recommendedSchemes
  } = data;
  
  // 1. 生成体检结论
  const conclusion = {
    max_amount: recommendedProducts.length > 0 ? 
      Math.max(...recommendedProducts.map(p => p.amount)) : 0,
    product_count: recommendedProducts.length,
    potential_increase: gaps.length > 0 ? gaps[0].potential_amount : 0,
    min_duration: recommendedSchemes.length > 0 ? 
      Math.min(...recommendedSchemes.map(s => s.duration_months)) : 0
  };
  
  // 2. 生成诊断建议
  const diagnosis = generateDiagnosisSummary({
    current_status: conclusion,
    recommended_products: recommendedProducts,
    recommended_schemes: recommendedSchemes
  });
  
  // 3. 组装报告
  return {
    report_id: generateReportId(),
    generate_date: new Date().toISOString().split('T')[0],
    company_name: normalizedAnswers.company_name || "您的企业",
    
    conclusion: {
      ...conclusion,
      diagnosis: diagnosis
    },
    
    recommended_products: recommendedProducts.slice(0, 3),
    all_products: recommendedProducts,
    
    gaps: gaps,
    
    recommended_schemes: recommendedSchemes.slice(0, 3),
    
    raw_answers: normalizedAnswers
  };
}
```

**输出**：完整报告数据

```json
{
  "report_id": "RPT20251206001",
  "generate_date": "2025-12-06",
  "company_name": "长沙XX机械制造有限公司",
  "conclusion": {
    "max_amount": 5250000,
    "product_count": 6,
    "potential_increase": 1800000,
    "min_duration": 5.5,
    "diagnosis": "您当前可以申请中高额度产品，建议优先申请招商银行经营抵押贷（额度最高、利率低）。通过开票提升方案，可进一步增加额度至700万。"
  },
  "recommended_products": [...],
  "gaps": [...],
  "recommended_schemes": [...]
}
```

---

## 三、关键业务规则

### 3.1 准入条件判断规则

**规则优先级**：

1. **硬性排斥**（直接拒绝）
   - 企业成立时间不足
   - 行业限制（房地产等）
   - 征信严重问题（暂未实现，预留接口）

2. **条件缺口**（可改造）
   - 开票额不足
   - 纳税额不足
   - 纳税等级低
   - 无抵押物
   - 无特殊资质

3. **加分条件**（提升额度/降低利率）
   - 开票连续性好
   - 行业优质（制造业、IT、科研）
   - 纳税等级高
   - 有专利
   - 有特殊身份

**判断示例**：

```javascript
function checkEligibility(product, answers) {
  // 1. 硬性排斥检查
  if (answers.company_age_years < product.min_years) {
    return { eligible: false, reason: "company_too_young" };
  }
  
  if (product.excluded_industries.includes(answers.industry)) {
    return { eligible: false, reason: "industry_excluded" };
  }
  
  // 2. 条件缺口检查
  if (product.type === "发票贷") {
    if (answers.annual_invoice_amount_min < product.min_invoice_amount) {
      // 如果差距不大（≥50%），视为"接近"
      if (answers.annual_invoice_amount_min >= product.min_invoice_amount * 0.5) {
        return {
          eligible: false,
          nearMiss: true,
          gap_type: "invoice_insufficient",
          current_value: answers.annual_invoice_amount_min,
          target_value: product.min_invoice_amount
        };
      } else {
        return { eligible: false, reason: "invoice_too_low" };
      }
    }
  }
  
  // 3. 所有条件都满足
  return { eligible: true };
}
```

---

### 3.2 额度计算规则

**规则分类**：

| 产品类型 | 基础公式 | 系数/倍数范围 | 影响因素 |
|---------|---------|-------------|---------|
| 发票贷 | 年开票额 × 系数 | 5%-30% | 开票稳定性、行业 |
| 税贷 | 年纳税额 × 倍数 | 5-30倍 | 纳税等级、年限 |
| 抵押贷 | 房产估值 × 抵押率 | 50%-70% | 房产类型、位置 |
| 高新企业贷 | 资质等级固定额度 | 200-1000万 | 专利、投资 |
| 特殊人群贷 | 政策固定额度 | 30-500万 | 身份类型 |
| 经营快贷 | 综合评分模型 | 30-500万 | 营收、开票、纳税 |

**计算优先级**：

```javascript
function calculateAmount(product, answers) {
  switch(product.type) {
    case "发票贷":
      return calculateInvoiceLoanAmount(answers, product);
    case "税贷":
      return calculateTaxLoanAmount(answers, product);
    case "抵押贷":
      return calculateMortgageLoanAmount(answers, product);
    // ... 其他类型
  }
}
```

**边界处理**：

```javascript
// 1. 额度上限
let amount = baseAmount;
amount = Math.min(amount, product.max_amount);

// 2. 额度下限
amount = Math.max(amount, product.min_amount || 0);

// 3. 四舍五入（万元）
amount = Math.round(amount / 10000) * 10000;
```

---

### 3.3 缺口识别规则

**识别条件**：

1. **产品不匹配**（eligible = false）
2. **差距不大**（nearMiss = true）
3. **有改造价值**（potential_amount > 成本）

**差距阈值**：

| 缺口类型 | 阈值标准 | 示例 |
|---------|---------|------|
| 开票额不足 | 当前值 ≥ 目标值 × 50% | 当前150万 vs 目标300万 → 接近 |
| 纳税额不足 | 当前值 ≥ 目标值 × 30% | 当前1万 vs 目标5万 → 较远 |
| 纳税等级低 | C级 → B级 或 B级 → A级 | C级 → A级 → 跨度太大，不推荐 |
| 无抵押物 | - | 直接识别为缺口 |
| 无特殊资质 | - | 直接识别为缺口 |

**示例代码**：

```javascript
function isNearMiss(gapType, currentValue, targetValue) {
  const thresholds = {
    "invoice_insufficient": 0.5,  // 50%
    "tax_insufficient": 0.3,      // 30%
    "tax_level_low": true         // 特殊处理
  };
  
  if (gapType === "tax_level_low") {
    // B级→A级：可以改造
    // C级→A级：跨度太大，不推荐
    const levelGap = getLevelGap(currentValue, targetValue);
    return levelGap === 1;
  }
  
  const threshold = thresholds[gapType] || 0.5;
  return currentValue >= targetValue * threshold;
}
```

---

### 3.4 方案推荐规则

**推荐优先级**：

1. **ROI最高**（权重50%）
2. **周期最短**（权重30%）
3. **成本最低**（权重20%）

**推荐数量**：

- 最多推荐3个方案
- 如果只有1-2个缺口，只推荐对应方案
- 如果无缺口，不推荐方案

**方案排序公式**：

```javascript
function rankSchemes(schemes) {
  const maxROI = Math.max(...schemes.map(s => parseFloat(s.roi)));
  const maxDuration = Math.max(...schemes.map(s => s.duration_months));
  const maxCost = Math.max(...schemes.map(s => s.cost));
  
  return schemes.map(s => ({
    ...s,
    score: (parseFloat(s.roi) / maxROI) * 50 +
           (1 - s.duration_months / maxDuration) * 30 +
           (1 - s.cost / maxCost) * 20
  }))
  .sort((a, b) => b.score - a.score);
}
```

---

## 四、异常处理

### 4.1 问卷数据异常

| 异常类型 | 检测方式 | 处理方式 |
|---------|---------|---------|
| 必填项缺失 | 提交前前端验证 | 阻止提交，提示补充 |
| 数据类型错误 | 后端接收时验证 | 返回400错误，提示重新填写 |
| 枚举值非法 | 后端验证枚举范围 | 返回400错误，提示刷新页面 |
| 逻辑矛盾 | 业务规则检查 | 记录日志，使用默认值 |

**示例代码**：

```javascript
function validateAnswers(answers) {
  const errors = [];
  
  // 1. 必填项检查
  const requiredFields = [
    'city', 'industry', 'company_age',
    'annual_revenue', 'annual_invoice_amount',
    'annual_tax_amount', 'tax_credit_level',
    'has_property', 'has_patent',
    'special_identity', 'special_qualification'
  ];
  
  for (let field of requiredFields) {
    if (answers[field] === undefined || answers[field] === null) {
      errors.push(`缺少必填项：${field}`);
    }
  }
  
  // 2. 逻辑检查
  if (answers.annual_invoice_amount !== "no_invoice" && 
      !answers.invoice_duration) {
    errors.push("有开票但未填写开票时长");
  }
  
  if (answers.has_property && !answers.property_value) {
    errors.push("有房产但未填写估值");
  }
  
  return {
    valid: errors.length === 0,
    errors: errors
  };
}
```

---

### 4.2 产品匹配异常

| 异常类型 | 场景 | 处理方式 |
|---------|------|---------|
| 无匹配产品 | 条件太差或太特殊 | 返回空列表，推荐改造方案 |
| 匹配产品过多 | 条件优秀 | 只返回Top 10，按评分排序 |
| 额度计算溢出 | 数值过大 | 限制最大值为1000万 |
| 产品库为空 | 系统错误 | 返回500错误，记录日志 |

**示例代码**：

```javascript
function handleMatchingResult(matchedProducts, normalizedAnswers) {
  // 1. 无匹配产品
  if (matchedProducts.length === 0) {
    return {
      status: "no_match",
      message: "根据您当前的情况，暂时没有完全匹配的产品。但通过以下改造方案，您可以达到申请条件：",
      recommended_products: [],
      gaps: detectGaps(normalizedAnswers, allProducts),
      recommended_schemes: recommendSchemes(gaps, schemeDatabase)
    };
  }
  
  // 2. 匹配产品过多
  if (matchedProducts.length > 10) {
    matchedProducts = matchedProducts.slice(0, 10);
  }
  
  // 3. 正常返回
  return {
    status: "success",
    recommended_products: matchedProducts
  };
}
```

---

### 4.3 方案推荐异常

| 异常类型 | 场景 | 处理方式 |
|---------|------|---------|
| 无对应方案 | 缺口类型未覆盖 | 跳过该缺口，记录日志 |
| ROI计算异常 | 除数为0或负数 | 标记为"无法计算"，排序最后 |
| 方案库为空 | 系统错误 | 返回空列表，不影响报告 |

**示例代码**：

```javascript
function safeCalculateROI(gap, scheme) {
  try {
    if (scheme.cost <= 0) {
      throw new Error("成本必须大于0");
    }
    
    const roi = ((gap.potential_amount / scheme.cost) * 100).toFixed(2);
    
    if (isNaN(roi) || !isFinite(roi)) {
      throw new Error("ROI计算结果异常");
    }
    
    return roi + "%";
  } catch (error) {
    console.error(`ROI计算异常：${error.message}`);
    return "无法计算";
  }
}
```

---

## 五、边界Case处理

### 5.1 极端情况

#### Case 1：新成立企业（<1年）

**特征**：
- 成立时间 < 1年
- 无开票或开票很少
- 无纳税或纳税很少

**处理逻辑**：
```javascript
if (answers.company_age === "less_than_1") {
  // 1. 只推荐特殊人群贷（如果符合）
  if (answers.special_identity.includes("graduate") || 
      answers.special_identity.includes("veteran")) {
    // 可以申请创业贷
  }
  
  // 2. 不推荐其他产品（都有年限要求）
  
  // 3. 推荐改造方案：等待时间或加快开票/纳税
  recommendedSchemes = [
    {
      scheme_name: "时间等待",
      description: "建议再经营6-12个月，积累开票和纳税记录后再申请",
      cost: 0,
      duration: "6-12个月"
    }
  ];
}
```

---

#### Case 2：无开票无纳税

**特征**：
- 年开票额 = 0
- 年纳税额 < 1万

**处理逻辑**：
```javascript
if (answers.annual_invoice_amount === "no_invoice" &&
    answers.annual_tax_amount === "less_than_1w") {
  
  // 1. 检查是否有其他优势
  if (answers.has_property) {
    // 推荐抵押贷
  } else if (answers.special_qualification.length > 0) {
    // 推荐高新企业贷
  } else {
    // 2. 无任何优势，推荐改造方案
    gaps = [
      {
        gap_type: "invoice_insufficient",
        gap_description: "无开票记录",
        current_value: 0,
        target_value: 1000000,
        potential_amount: 3000000
      },
      {
        gap_type: "tax_insufficient",
        gap_description: "纳税额过低",
        current_value: 5000,
        target_value: 50000,
        potential_amount: 1500000
      }
    ];
  }
}
```

---

#### Case 3：条件极度优秀

**特征**：
- 年开票额 > 3000万
- 年纳税额 > 50万
- 有房产抵押
- 有高新资质

**处理逻辑**：
```javascript
if (isExcellentCondition(answers)) {
  // 1. 所有产品都匹配
  // 2. 无缺口
  gaps = [];
  
  // 3. 无需改造
  recommendedSchemes = [];
  
  // 4. 诊断建议强调优势
  diagnosis = "您的条件非常优秀，可以申请市场上几乎所有的信贷产品。" +
              "建议根据资金用途和还款计划，选择最适合的产品组合。";
}
```

---

### 5.2 特殊身份组合

#### Case 4：大学生 + 高新企业

**处理逻辑**：
```javascript
if (answers.special_identity.includes("graduate") &&
    answers.special_qualification.includes("high_tech")) {
  
  // 1. 两类产品都推荐
  recommendedProducts = [
    ...specialIdentityLoans,  // 大学生创业贷
    ...highTechLoans          // 高新企业贷
  ];
  
  // 2. 在诊断建议中说明组合优势
  diagnosis = "您既符合大学生创业贷条件，又有高新技术企业资质，" +
              "建议组合使用：大学生创业贷（有财政贴息）+ 高新企业贷（额度高），" +
              "充分发挥政策优势。";
}
```

---

### 5.3 数据矛盾

#### Case 5：高营收但低开票

**特征**：
- 年营收 = 1000-3000万
- 年开票额 < 100万

**处理逻辑**：
```javascript
if (answers.annual_revenue_min > answers.annual_invoice_amount_min * 5) {
  // 1. 记录日志（可能数据异常或企业不规范开票）
  console.warn("营收与开票额差距过大，可能存在数据异常");
  
  // 2. 优先使用开票额（更可靠）
  // 3. 在报告中提示
  warnings = [
    "检测到年营收远高于年开票额，建议核实开票情况，规范开票可以大幅提升贷款额度。"
  ];
}
```

---

## 六、性能优化

### 6.1 计算优化

**缓存策略**：

```javascript
// 1. 产品库缓存（内存）
const productCache = {
  data: null,
  lastUpdate: null,
  ttl: 3600000  // 1小时
};

function getProductDatabase() {
  const now = Date.now();
  
  if (!productCache.data || 
      (now - productCache.lastUpdate) > productCache.ttl) {
    productCache.data = loadProductsFromDB();
    productCache.lastUpdate = now;
  }
  
  return productCache.data;
}
```

**并发计算**：

```javascript
// 2. 产品筛选和额度计算并发
async function matchProductsConcurrently(normalizedAnswers) {
  const products = getProductDatabase();
  
  const promises = products.map(async product => {
    const eligible = await checkEligibility(product, normalizedAnswers);
    
    if (eligible) {
      const amount = await calculateAmount(product, normalizedAnswers);
      return { ...product, amount };
    }
    
    return null;
  });
  
  const results = await Promise.all(promises);
  return results.filter(r => r !== null);
}
```

---

### 6.2 响应时间目标

| 操作 | 目标时间 | 说明 |
|------|---------|------|
| 问卷提交 | < 200ms | 前端验证 + 提交API |
| 后台计算 | < 2秒 | 产品匹配 + 方案推荐 |
| 报告渲染 | < 500ms | 前端渲染 |
| PDF生成 | < 3秒 | jsPDF生成 |
| **总耗时** | **< 6秒** | 从提交到看到报告 |

---

## 七、数据持久化（可选）

### 7.1 诊断记录存储

**存储目的**：
- 统计分析（产品匹配率、方案推荐率）
- A/B测试（不同算法效果对比）
- 用户画像（企业类型分布）

**存储内容**：
```sql
CREATE TABLE diagnosis_records (
  id SERIAL PRIMARY KEY,
  report_id VARCHAR(50) UNIQUE,
  company_name VARCHAR(100),
  
  -- 问卷答案（JSON）
  raw_answers JSONB,
  normalized_answers JSONB,
  
  -- 匹配结果
  matched_product_count INTEGER,
  max_amount DECIMAL(15,2),
  
  -- 缺口和方案
  gap_count INTEGER,
  scheme_count INTEGER,
  
  -- 元数据
  created_at TIMESTAMP DEFAULT NOW(),
  ip_address VARCHAR(50),
  user_agent TEXT
);
```

**隐私保护**：
- 企业名称可选（用户可不填）
- IP地址脱敏
- 定期清理（90天后删除）

---

### 7.2 产品匹配统计

**统计维度**：
```sql
-- 产品匹配率
SELECT 
  product_name,
  COUNT(*) as match_count,
  AVG(amount) as avg_amount
FROM diagnosis_records, 
     jsonb_array_elements(normalized_answers->'matched_products') as mp
GROUP BY product_name
ORDER BY match_count DESC;
```

```sql
-- 方案推荐率
SELECT 
  scheme_name,
  COUNT(*) as recommend_count,
  AVG((scheme->'roi')::numeric) as avg_roi
FROM diagnosis_records,
     jsonb_array_elements(normalized_answers->'recommended_schemes') as scheme
GROUP BY scheme_name
ORDER BY recommend_count DESC;
```

---

## 八、版本迭代计划

### v1.0（当前版本）

**已实现**：
- ✅ 15个产品匹配
- ✅ 3个改造方案
- ✅ 基础额度算法
- ✅ 简单缺口识别

**已知限制**：
- ⚠️ 未包含征信检查（问卷未收集）
- ⚠️ 未包含企业流水分析
- ⚠️ 未包含历史贷款分析

---

### v1.1（计划）

**新增功能**：
- [ ] 征信查询接口对接
- [ ] 更精细的额度算法（考虑更多因素）
- [ ] 更多银行产品（20+）
- [ ] 更多改造方案（10+）

---

### v2.0（远期）

**新增功能**：
- [ ] AI推荐（机器学习模型）
- [ ] 实时利率更新
- [ ] 银行直连（自动提交申请）
- [ ] 用户画像和个性化推荐

---

## 九、版本更新记录

| 版本 | 日期 | 修改内容 | 作者 |
|------|------|---------|------|
| v1.0 | 2025-12-06 | 初版，完整业务逻辑 | Claude |

---

**文档状态**：✅ 已完成  
**交付标准**：开发团队理解完整业务逻辑，可以开始系统设计和编码  
**下一步**：创建"案例00-模板.md"

---

## 附录：标准诊断流程（4步法）

本流程适用于所有改造方案的客户诊断，具体细节可根据业务调整。

### 标准流程

```
┌─────────────────────────────────────────────────────────────┐
│  Step 1：信息收集（30分钟-1小时）                            │
│  • 与客户沟通，收集基本信息                                  │
│  • 填写《客户信息收集表》                                    │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  Step 2：资质核查（1-3天）                                   │
│  • 查企业征信                                                │
│  • 查法人个人征信                                            │
│  • 查企业经营状态（企查查/天眼查）                           │
│  • 获取相关数据（开票、纳税等）                              │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  Step 3：现状评估（1-2小时）                                 │
│  • 计算当前可贷额度                                          │
│  • 分析与目标的差距                                          │
│  • 判断改造可行性                                            │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  Step 4：方案设计（2-3小时）                                 │
│  • 设计改造目标                                              │
│  • 设计执行路径                                              │
│  • 估算成本和周期                                            │
│  • 预测改造后效果                                            │
└─────────────────────────────────────────────────────────────┘
                              ↓
                          输出诊断报告
```

### 标准信息收集表

| 信息类别 | 具体项目 | 获取方式 |
|---------|---------|---------|
| **企业基本信息** | 企业名称、成立年限、注册资本 | 营业执照 |
| | 法人姓名、年龄、股权比例 | 工商信息 |
| | 经营范围、主营业务 | 客户描述 |
| **财务信息** | 年营收、年利润 | 客户描述 |
| | 年开票额、月开票额 | 电子税务局导出 |
| | 年纳税额、纳税等级 | 电子税务局查询 |
| **融资信息** | 现有贷款额度、利率 | 客户描述 |
| | 目标贷款额度 | 客户需求 |
| | 资金用途、紧迫程度 | 客户需求 |
| **征信信息** | 法人个人征信 | 征信报告 |
| | 企业征信 | 企业征信报告 |

---

**特定业务的诊断细节**：
- H业务诊断：见 `07_业务运营/H业务/诊断流程和模板.md`
- G业务诊断：（待补充）
- 税务优化诊断：（待补充）

---

*本文档是整个贷查查系统的核心业务逻辑说明，请开发团队严格按照此逻辑实现。*
