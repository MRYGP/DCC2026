# æ•°æ®åº“è®¾è®¡æ–‡æ¡£ v1.4

**ç‰ˆæœ¬**ï¼šv1.4  
**åˆ›å»ºæ—¥æœŸ**ï¼š2026-02-05  
**æœ€åæ›´æ–°**ï¼š2026-02-06  
**ç»´æŠ¤äºº**ï¼šæŠ€æœ¯å›¢é˜Ÿ

---

## 1. è®¾è®¡åŸåˆ™

### 1.1 ç®€åŒ–è®¾è®¡ï¼ˆæœ‹å‹éªŒè¯ç‰ˆï¼‰

**æ ¸å¿ƒåŸåˆ™**ï¼š
- æ¯ä¸ªæœ‹å‹ç‹¬ç«‹æ•°æ®åº“æ–‡ä»¶ï¼ˆSQLiteï¼‰
- ç®€åŒ–è¡¨ç»“æ„ï¼Œèšç„¦æ ¸å¿ƒåŠŸèƒ½
- å»æ‰å†…æµ‹é˜¶æ®µä¸éœ€è¦çš„å¤æ‚åŠŸèƒ½
- ä¾¿äºç‹¬ç«‹éƒ¨ç½²å’Œæ•°æ®éš”ç¦»

### 1.2 è¡¨ç»“æ„ç®€åŒ–

**å»æ‰çš„è¡¨**ï¼š
- âŒ å¤æ‚çš„å®¡è®¡æ—¥å¿—è¡¨
- âŒ åˆ†ä½£ç›¸å…³è¡¨ï¼ˆè®¢å•ã€å¯¹è´¦ï¼‰
- âŒ å¤šç§Ÿæˆ·å¤æ‚æƒé™è¡¨
- âŒ å¤æ‚çš„ç‰ˆæœ¬ç®¡ç†è¡¨

**ä¿ç•™çš„è¡¨**ï¼š
- âœ… ç§Ÿæˆ·è¡¨ï¼ˆç®€åŒ–ç‰ˆï¼‰
- âœ… å®¢æˆ·è¡¨ï¼ˆ13ä¸ªå¿…å¡«å­—æ®µï¼‰
- âœ… è¯Šæ–­è®°å½•è¡¨ï¼ˆå…­å®«æ ¼è¯„åˆ†ï¼‰
- âœ… æ”¹é€ æ–¹æ¡ˆè¡¨ï¼ˆæ–¹æ¡ˆè®°å½•ï¼‰
- âœ… æ“ä½œæ—¥å¿—è¡¨ï¼ˆç®€åŒ–ç‰ˆï¼‰
- âœ… ä½¿ç”¨ç»Ÿè®¡è¡¨ï¼ˆæœ‹å‹ä½¿ç”¨æ•°æ®ï¼‰

### 1.3 ç‹¬ç«‹éƒ¨ç½²ä¼˜åŠ¿

**æ•°æ®éš”ç¦»**ï¼š
- æ¯ä¸ªæœ‹å‹ç‹¬ç«‹æ•°æ®åº“æ–‡ä»¶
- ç‰©ç†éš”ç¦»ï¼Œæ›´å®‰å…¨
- æœ‹å‹æ›´ä¿¡ä»»

**éƒ¨ç½²ç®€å•**ï¼š
- æ— éœ€å¤æ‚çš„å¤šç§Ÿæˆ·é€»è¾‘
- æ¯ä¸ªå®ä¾‹ç‹¬ç«‹è¿è¡Œ
- ä¸€é”®éƒ¨ç½²è„šæœ¬

**ç»´æŠ¤æ–¹ä¾¿**ï¼š
- ä¸€ä¸ªæœ‹å‹å‡ºé—®é¢˜ä¸å½±å“å…¶ä»–
- ç‹¬ç«‹å¤‡ä»½æ¢å¤
- ç‹¬ç«‹ç›‘æ§æ—¥å¿—

---

## 2. æ ¸å¿ƒè¡¨è®¾è®¡

### 2.1 ç§Ÿæˆ·è¡¨ï¼ˆtenantsï¼‰

```sql
-- æ¯ä¸ªæœ‹å‹ä¸€ä¸ªç§Ÿæˆ·ï¼ˆç‹¬ç«‹éƒ¨ç½²æ—¶æ¯ä¸ªå®ä¾‹åªæœ‰ä¸€æ¡è®°å½•ï¼‰
CREATE TABLE tenants (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    
    -- åŸºç¡€ä¿¡æ¯
    name TEXT NOT NULL UNIQUE,           -- æœ‹å‹å§“å/å…¬å¸åç§°
    logo_path TEXT,                      -- Logoæ–‡ä»¶è·¯å¾„
    primary_color TEXT DEFAULT '#1890ff', -- ä¸»è‰²è°ƒ
    secondary_color TEXT DEFAULT '#52c41a', -- è¾…è‰²è°ƒ
    
    -- é…ç½®ä¿¡æ¯
    config_json TEXT DEFAULT '{}',       -- JSONæ ¼å¼é…ç½®
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- V1è½»å¤åˆ¶æ–°å¢å­—æ®µï¼ˆV0å¯ä¸å®ç°ï¼‰
    partner_id VARCHAR(20) UNIQUE,  -- ä¸“å±IDï¼ˆM001, M002...ï¼‰
    brand_name VARCHAR(100),  -- å“ç‰Œåç§°
    logo_url VARCHAR(500),  -- Logoåœ°å€
    contact_phone VARCHAR(20),  -- è”ç³»ç”µè¯
    contact_wechat VARCHAR(50),  -- å¾®ä¿¡å·
    contact_address VARCHAR(200),  -- è”ç³»åœ°å€
    theme_color VARCHAR(20) DEFAULT '#1890ff'  -- ä¸»é¢˜è‰²
);

-- ç®€åŒ–ï¼šæ¯ä¸ªå®ä¾‹åªæœ‰ä¸€ä¸ªç§Ÿæˆ·ï¼Œæ‰€ä»¥ä¸éœ€è¦å¤æ‚çš„ç§Ÿæˆ·ç®¡ç†
```

**å­—æ®µè¯´æ˜ï¼ˆV1è½»å¤åˆ¶ï¼‰**ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | V0 | V1 | ç¤ºä¾‹ |
|------|------|------|----|----|------|
| partner_id | VARCHAR(20) | ä¸“å±IDï¼ˆå”¯ä¸€ï¼‰ | âŒ | âœ… | M001 |
| brand_name | VARCHAR(100) | å“ç‰Œåç§° | âŒ | âœ… | XXè´·æ¬¾é¡¾é—® |
| logo_url | VARCHAR(500) | Logoåœ°å€ | âŒ | âœ… | https://xxx/logo.png |
| contact_phone | VARCHAR(20) | è”ç³»ç”µè¯ | âŒ | âœ… | 138****1234 |
| contact_wechat | VARCHAR(50) | å¾®ä¿¡å· | âŒ | âœ… | xxx |
| contact_address | VARCHAR(200) | è”ç³»åœ°å€ | âŒ | âœ… | é•¿æ²™å¸‚ |
| theme_color | VARCHAR(20) | ä¸»é¢˜è‰² | âŒ | âœ… | #1890ff |

**è½»å¤åˆ¶æœºåˆ¶è¯´æ˜**ï¼š
```
å®¢æˆ·è®¿é—®ï¼šdomain.com?partner_id=M001
  â†“
ç³»ç»ŸæŸ¥è¯¢tenantsè¡¨ â†’ æ‰¾åˆ°M001çš„å“ç‰Œé…ç½®
  â†“
é¡µé¢æ˜¾ç¤ºï¼š
  â”œâ”€ Logoï¼šlogo_url
  â”œâ”€ åç§°ï¼šbrand_name
  â”œâ”€ è”ç³»æ–¹å¼ï¼šcontact_phone, contact_wechat
  â””â”€ ä¸»é¢˜è‰²ï¼štheme_color
  â†“
å®¢æˆ·å¡«å†™æ•°æ® â†’ è‡ªåŠ¨æ ‡è®°source_partner_id = M001
  â†“
æ•°æ®å½’å±ï¼šmiddleman_id = M001å¯¹åº”çš„tenant_id
```

### 2.2 å®¢æˆ·è¡¨ï¼ˆcustomersï¼‰

```sql
-- å®¢æˆ·åŸºæœ¬ä¿¡æ¯ï¼ˆ13ä¸ªå¿…å¡«å­—æ®µï¼‰
CREATE TABLE customers (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    tenant_id INTEGER NOT NULL,
    
    -- 13ä¸ªå¿…å¡«å­—æ®µ
    name TEXT NOT NULL,                  -- ä¼ä¸šåç§°
    reg_capital REAL,                    -- æ³¨å†Œèµ„æœ¬ï¼ˆä¸‡å…ƒï¼‰
    established_date DATE,               -- æˆç«‹æ—¶é—´
    legal_person TEXT,                   -- æ³•äººå§“å
    
    annual_invoice REAL,                 -- å¹´å¼€ç¥¨ï¼ˆä¸‡å…ƒï¼‰
    annual_tax REAL,                     -- å¹´çº³ç¨ï¼ˆä¸‡å…ƒï¼‰
    monthly_flow REAL,                   -- å¯¹å…¬æµæ°´æœˆå‡ï¼ˆä¸‡å…ƒï¼‰
    
    legal_credit TEXT,                   -- æ³•äººå¾ä¿¡ï¼ˆæ— é€¾æœŸ/M1é€¾æœŸ/M3+é€¾æœŸï¼‰
    company_credit TEXT,                 -- ä¼ä¸šå¾ä¿¡ï¼ˆæ­£å¸¸/å¼‚å¸¸ï¼‰
    
    main_business TEXT,                  -- ä¸»è¥ä¸šåŠ¡
    industry TEXT,                       -- è¡Œä¸š
    
    loan_demand REAL,                    -- è´·æ¬¾éœ€æ±‚ï¼ˆä¸‡å…ƒï¼‰
    collateral TEXT,                     -- æŠµæŠ¼ç‰©æƒ…å†µï¼ˆæœ‰æˆ¿äº§/150ä¸‡/æ— ï¼‰
    
    -- çŠ¶æ€ä¿¡æ¯
    status TEXT DEFAULT 'active',        -- active/archived/deleted
    category TEXT,                       -- A/B/Cï¼ˆè¯Šæ–­ç»“æœï¼‰
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- V1è½»å¤åˆ¶æ–°å¢å­—æ®µï¼ˆV0å¯ä¸å®ç°ï¼‰
    source_partner_id VARCHAR(20),  -- æ¥æºä¸­ä»‹ID
    source_channel VARCHAR(50),  -- æ¥æºæ¸ é“
    source_url VARCHAR(500),  -- æ¥æºURL
    
    FOREIGN KEY (tenant_id) REFERENCES tenants(id)
);

-- ç´¢å¼•
CREATE INDEX idx_customers_tenant_id ON customers(tenant_id);
CREATE INDEX idx_customers_category ON customers(category);
CREATE INDEX idx_customers_created_at ON customers(created_at);
```

**å­—æ®µè¯´æ˜ï¼ˆV1è½»å¤åˆ¶ï¼‰**ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | V0 | V1 | ç¤ºä¾‹ |
|------|------|------|----|----|------|
| source_partner_id | VARCHAR(20) | æ¥æºä¸­ä»‹ID | âŒ | âœ… | M001 |
| source_channel | VARCHAR(50) | æ¥æºæ¸ é“ | âŒ | âœ… | wechat_moments/h5_link |
| source_url | VARCHAR(500) | æ¥æºURL | âŒ | âœ… | domain.com?partner_id=M001 |

**ç”¨é€”**ï¼š
- è¿½è¸ªå®¢æˆ·æ¥æºï¼ˆæœ‹å‹åœˆæµ·æŠ¥/H5é“¾æ¥/å°ç¨‹åºï¼‰
- æ•°æ®å½’å±æ¸…æ™°ï¼ˆå®¢æˆ·å±äºå“ªä¸ªä¸­ä»‹ï¼‰
- åˆ†æè½¬åŒ–ç‡ï¼ˆå“ªä¸ªæ¸ é“è½¬åŒ–ç‡é«˜ï¼‰

### 2.3 è¯Šæ–­è®°å½•è¡¨ï¼ˆdiagnosis_recordsï¼‰

```sql
-- è¯Šæ–­è®°å½•ï¼ˆæ¯æ¬¡è¯Šæ–­ç”Ÿæˆä¸€æ¡è®°å½•ï¼‰
CREATE TABLE diagnosis_records (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    tenant_id INTEGER NOT NULL,
    customer_id INTEGER NOT NULL,
    
    -- å…­å®«æ ¼å¾—åˆ†
    flow_score INTEGER DEFAULT 0,        -- æµæ°´ä½“è´¨å¾—åˆ†ï¼ˆ0-200ï¼‰
    invoice_tax_score INTEGER DEFAULT 0, -- ç¥¨ç¨ä½“è´¨å¾—åˆ†ï¼ˆ0-200ï¼‰
    credit_score INTEGER DEFAULT 0,      -- å¾ä¿¡ä½“è´¨å¾—åˆ†ï¼ˆ0-200ï¼‰
    asset_score INTEGER DEFAULT 0,       -- èµ„äº§ä½“è´¨å¾—åˆ†ï¼ˆ0-150ï¼‰
    qualification_score INTEGER DEFAULT 0, -- èµ„è´¨ä½“è´¨å¾—åˆ†ï¼ˆ0-150ï¼‰
    industry_score INTEGER DEFAULT 0,    -- è¡Œä¸šä½“è´¨å¾—åˆ†ï¼ˆ0-100ï¼‰
    
    total_score INTEGER DEFAULT 0,       -- æ€»åˆ†ï¼ˆ0-1000ï¼‰
    category TEXT CHECK(category IN ('A', 'B', 'C')), -- A/B/Cåˆ†ç±»
    
    -- è¯Šæ–­è¯¦æƒ…
    diagnosis_reason TEXT,               -- è¯Šæ–­ç†ç”±ï¼ˆJSONæ ¼å¼ï¼‰
    raw_data_json TEXT,                  -- åŸå§‹æ•°æ®ï¼ˆJSONæ ¼å¼ï¼Œç”¨äºè¿½æº¯ï¼‰
    
    -- äººå·¥å¤æ ¸
    manual_reviewed BOOLEAN DEFAULT FALSE, -- æ˜¯å¦äººå·¥å¤æ ¸
    manual_category TEXT,                -- äººå·¥åˆ†ç±»ï¼ˆA/B/Cï¼‰
    manual_reason TEXT,                  -- äººå·¥å¤æ ¸ç†ç”±
    reviewed_by TEXT,                    -- å¤æ ¸äºº
    reviewed_at TIMESTAMP,               -- å¤æ ¸æ—¶é—´
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (tenant_id) REFERENCES tenants(id),
    FOREIGN KEY (customer_id) REFERENCES customers(id)
);

-- ç´¢å¼•
CREATE INDEX idx_diagnosis_tenant_id ON diagnosis_records(tenant_id);
CREATE INDEX idx_diagnosis_customer_id ON diagnosis_records(customer_id);
CREATE INDEX idx_diagnosis_category ON diagnosis_records(category);
CREATE INDEX idx_diagnosis_created_at ON diagnosis_records(created_at);
```

---

### 2.4 result_feedbackï¼ˆç»“æœå›å¡«è¡¨ï¼‰â­â­â­â­â­

**åŠŸèƒ½å®šä½**ï¼šæ•°æ®é£è½®æ ¸å¿ƒï¼Œå†³å®šç³»ç»Ÿèƒ½å¦"è¶Šç”¨è¶Šå‡†"

**è¡¨ç»“æ„**ï¼š
```sql
CREATE TABLE result_feedback (
    result_id VARCHAR(50) PRIMARY KEY,
    customer_id VARCHAR(50) NOT NULL,
    product_id VARCHAR(50) NOT NULL,
    apply_date DATE NOT NULL,
    result VARCHAR(20) NOT NULL,  -- approved/rejected
    reject_reason VARCHAR(50),  -- æ‹’ç»åŸå› ï¼ˆå…­å®«æ ¼å½’å› ï¼‰
    predicted_amount DECIMAL(15, 2),  -- ç³»ç»Ÿé¢„æµ‹é¢åº¦
    actual_amount DECIMAL(15, 2),  -- å®é™…æ‰¹å¤é¢åº¦
    diff DECIMAL(15, 2),  -- å·®å¼‚ï¼ˆactual - predictedï¼‰
    middleman_id VARCHAR(50) NOT NULL,
    notes TEXT,  -- å¤‡æ³¨
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (customer_id) REFERENCES customers(customer_id),
    FOREIGN KEY (product_id) REFERENCES products(product_id),
    FOREIGN KEY (middleman_id) REFERENCES tenants(tenant_id),
    
    INDEX idx_customer_id (customer_id),
    INDEX idx_product_id (product_id),
    INDEX idx_middleman_id (middleman_id),
    INDEX idx_result (result),
    INDEX idx_apply_date (apply_date)
);
```

**å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å¿…å¡« | ç¤ºä¾‹ |
|------|------|------|------|------|
| result_id | VARCHAR(50) | ä¸»é”®ï¼Œç»“æœID | âœ… | R001 |
| customer_id | VARCHAR(50) | å®¢æˆ·ID | âœ… | C001 |
| product_id | VARCHAR(50) | äº§å“ID | âœ… | P001 |
| apply_date | DATE | ç”³è¯·æ—¥æœŸ | âœ… | 2026-01-20 |
| result | VARCHAR(20) | ç”³è¯·ç»“æœ | âœ… | approved/rejected |
| reject_reason | VARCHAR(50) | æ‹’ç»åŸå› ï¼ˆå…­å®«æ ¼ï¼‰ | âš ï¸ æ¡ä»¶å¿…å¡« | flow_insufficient |
| predicted_amount | DECIMAL(15,2) | ç³»ç»Ÿé¢„æµ‹é¢åº¦ | âŒ | 1000000.00 |
| actual_amount | DECIMAL(15,2) | å®é™…æ‰¹å¤é¢åº¦ | âŒ | 800000.00 |
| diff | DECIMAL(15,2) | å·®å¼‚ | âŒ | -200000.00 |
| middleman_id | VARCHAR(50) | ä¸­ä»‹ID | âœ… | M001 |
| notes | TEXT | å¤‡æ³¨ | âŒ | å®¢æˆ·ç»ç†è¯´... |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ | âœ… | è‡ªåŠ¨ç”Ÿæˆ |
| updated_at | TIMESTAMP | æ›´æ–°æ—¶é—´ | âœ… | è‡ªåŠ¨æ›´æ–° |

**æ‹’ç»åŸå› æšä¸¾å€¼ï¼ˆå…­å®«æ ¼å½’å› ï¼‰**ï¼š
```python
REJECT_REASONS = {
    "flow_insufficient": "æµæ°´ä¸è¶³/ä¸ç¨³å®š",
    "invoice_insufficient": "å¼€ç¥¨ä¸è¶³",
    "tax_insufficient": "çº³ç¨ä¸è¶³",
    "credit_issues": "å¾ä¿¡é—®é¢˜ï¼ˆæŸ¥è¯¢å¤š/è´Ÿå€ºé«˜/æœ‰é€¾æœŸï¼‰",
    "asset_insufficient": "èµ„äº§ä¸è¶³ï¼ˆæ— æŠµæŠ¼ç‰©ï¼‰",
    "qualification_missing": "èµ„è´¨ç¼ºå¤±ï¼ˆæ— é«˜æ–°ç­‰ï¼‰",
    "industry_restricted": "è¡Œä¸šé™åˆ¶",
    "other": "å…¶ä»–åŸå› ï¼ˆéœ€å¡«å†™notesï¼‰"
}
```

**ä¸šåŠ¡é€»è¾‘**ï¼š
1. å½•å…¥æ—¶æœºï¼šä¸­ä»‹ç”³è¯·äº§å“åï¼Œç»“æœå‡ºæ¥æ—¶å½•å…¥
2. å¼ºåˆ¶å½’å› ï¼šå¦‚æœresult=rejectedï¼Œå¿…é¡»é€‰æ‹©reject_reason
3. å®šæ—¶æé†’ï¼š15å¤©åè‡ªåŠ¨æé†’ä¸­ä»‹"å®¢æˆ·XXXæœ‰ç»“æœäº†å—ï¼Ÿ"
4. æ•°æ®é£è½®ï¼š
```
   æ¨èäº§å“P001 â†’ 10æ¬¡ç”³è¯· â†’ 8æ¬¡é€šè¿‡ï¼Œ2æ¬¡æ‹’ç»
   åˆ†ææ‹’ç»åŸå›  â†’ å‘ç°"æµæ°´æ³¢åŠ¨>30%"çš„å®¢æˆ·é€šè¿‡ç‡ä½
   ç³»ç»Ÿè°ƒæ•´è§„åˆ™ â†’ æµæ°´æ³¢åŠ¨>30% â†’ é™ä½æ¨èä¼˜å…ˆçº§
   å‡†ç¡®ç‡æå‡ï¼š85% â†’ 92%
```

**å›å¡«ç‡ç›®æ ‡**ï¼š
- V0ï¼š>50%ï¼ˆå‹‰å¼ºå¤Ÿç”¨ï¼‰
- V1ï¼š>80%ï¼ˆæ•°æ®é£è½®å¯åŠ¨ï¼‰

**æ¿€åŠ±æœºåˆ¶ï¼ˆV1å¢åŠ ï¼‰**ï¼š
- ç§¯åˆ†å¥–åŠ±ï¼šå›å¡«1æ¡ = 10ç§¯åˆ†
- åŠŸèƒ½è§£é”ï¼šå›å¡«<10æ¡åªèƒ½ç”¨åŸºç¡€åŠŸèƒ½
- è¿”ä½£æŒ‚é’©ï¼šå›å¡«ç‡>80%ï¼Œè¿”ä½£æ¯”ä¾‹+10%

**æŸ¥è¯¢ç¤ºä¾‹**ï¼š
```sql
-- æŸ¥è¯¢æŸäº§å“çš„æˆåŠŸç‡
SELECT 
    product_id,
    COUNT(*) as total,
    SUM(CASE WHEN result = 'approved' THEN 1 ELSE 0 END) as approved,
    ROUND(SUM(CASE WHEN result = 'approved' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) as success_rate
FROM result_feedback
WHERE product_id = 'P001'
GROUP BY product_id;

-- æŸ¥è¯¢æœ€å¸¸è§çš„æ‹’ç»åŸå› 
SELECT 
    reject_reason,
    COUNT(*) as count,
    ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM result_feedback WHERE result = 'rejected'), 2) as percentage
FROM result_feedback
WHERE result = 'rejected' AND reject_reason IS NOT NULL
GROUP BY reject_reason
ORDER BY count DESC;

-- æŸ¥è¯¢é¢„æµ‹å‡†ç¡®ç‡
SELECT 
    AVG(ABS(diff)) as avg_diff,
    MIN(diff) as min_diff,
    MAX(diff) as max_diff
FROM result_feedback
WHERE predicted_amount IS NOT NULL AND actual_amount IS NOT NULL;
```

### 2.6 æ”¹é€ æ–¹æ¡ˆè¡¨ï¼ˆimprovement_plansï¼‰

```sql
-- æ”¹é€ æ–¹æ¡ˆè®°å½•
CREATE TABLE improvement_plans (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    tenant_id INTEGER NOT NULL,
    customer_id INTEGER NOT NULL,
    diagnosis_id INTEGER NOT NULL,
    
    -- æ–¹æ¡ˆä¿¡æ¯
    plan_type TEXT NOT NULL,             -- æ–¹æ¡ˆç±»å‹ï¼ˆå¼€ç¥¨æå‡/çº³ç¨æå‡ç­‰ï¼‰
    plan_name TEXT,                      -- æ–¹æ¡ˆåç§°
    plan_description TEXT,               -- æ–¹æ¡ˆæè¿°
    
    -- æ–¹æ¡ˆå†…å®¹ï¼ˆJSONæ ¼å¼ï¼‰
    gap_list_json TEXT,                  -- ç¼ºå£æ¸…å•
    task_list_json TEXT,                 -- ä»»åŠ¡æ¸…å•
    service_providers_json TEXT,         -- æ¨èæœåŠ¡å•†
    effect_preview_json TEXT,            -- æ•ˆæœé¢„è§ˆ
    cost_estimation_json TEXT,           -- æˆæœ¬ä¼°ç®—
    
    -- çŠ¶æ€è·Ÿè¸ª
    status TEXT DEFAULT 'pending',       -- pending/in_progress/completed/cancelled
    progress_percentage INTEGER DEFAULT 0, -- è¿›åº¦ç™¾åˆ†æ¯”ï¼ˆ0-100ï¼‰
    
    -- æ‰§è¡Œä¿¡æ¯
    started_at TIMESTAMP,                -- å¼€å§‹æ—¶é—´
    completed_at TIMESTAMP,              -- å®Œæˆæ—¶é—´
    cancelled_at TIMESTAMP,              -- å–æ¶ˆæ—¶é—´
    cancelled_reason TEXT,               -- å–æ¶ˆåŸå› 
    
    -- æé†’è®¾ç½®
    reminder_enabled BOOLEAN DEFAULT TRUE, -- æ˜¯å¦å¯ç”¨æé†’
    reminder_days INTEGER DEFAULT 90,    -- æé†’å¤©æ•°ï¼ˆé»˜è®¤90å¤©ï¼‰
    last_reminded_at TIMESTAMP,          -- ä¸Šæ¬¡æé†’æ—¶é—´
    next_remind_at TIMESTAMP,            -- ä¸‹æ¬¡æé†’æ—¶é—´
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (tenant_id) REFERENCES tenants(id),
    FOREIGN KEY (customer_id) REFERENCES customers(id),
    FOREIGN KEY (diagnosis_id) REFERENCES diagnosis_records(id)
);

-- ç´¢å¼•
CREATE INDEX idx_plans_tenant_id ON improvement_plans(tenant_id);
CREATE INDEX idx_plans_customer_id ON improvement_plans(customer_id);
CREATE INDEX idx_plans_diagnosis_id ON improvement_plans(diagnosis_id);
CREATE INDEX idx_plans_status ON improvement_plans(status);
CREATE INDEX idx_plans_next_remind ON improvement_plans(next_remind_at);
```

### 2.7 æ“ä½œæ—¥å¿—è¡¨ï¼ˆoperation_logsï¼‰

```sql
-- ç®€åŒ–ç‰ˆæ“ä½œæ—¥å¿—ï¼ˆåŸºç¡€å®¡è®¡ï¼‰
CREATE TABLE operation_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    tenant_id INTEGER NOT NULL,
    
    -- æ“ä½œä¿¡æ¯
    operation_type TEXT NOT NULL,         -- create/update/delete/import/diagnosis/plan
    resource_type TEXT NOT NULL,         -- customer/diagnosis/plan
    resource_id INTEGER,                 -- èµ„æºID
    
    -- æ“ä½œè¯¦æƒ…
    operator TEXT DEFAULT 'system',      -- æ“ä½œäººï¼ˆé»˜è®¤systemï¼‰
    details_json TEXT,                   -- æ“ä½œè¯¦æƒ…ï¼ˆJSONæ ¼å¼ï¼‰
    ip_address TEXT,                     -- IPåœ°å€ï¼ˆå¯é€‰ï¼‰
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (tenant_id) REFERENCES tenants(id)
);

-- ç´¢å¼•
CREATE INDEX idx_logs_tenant_id ON operation_logs(tenant_id);
CREATE INDEX idx_logs_operation_type ON operation_logs(operation_type);
CREATE INDEX idx_logs_resource_type ON operation_logs(resource_type);
CREATE INDEX idx_logs_created_at ON operation_logs(created_at);
```

### 2.8 ä½¿ç”¨ç»Ÿè®¡è¡¨ï¼ˆusage_statsï¼‰

```sql
-- æœ‹å‹ä½¿ç”¨æ•°æ®ç»Ÿè®¡ï¼ˆç”¨äºéªŒè¯ï¼‰
CREATE TABLE usage_stats (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    tenant_id INTEGER NOT NULL,
    
    -- ç»Ÿè®¡ç»´åº¦
    stat_date DATE NOT NULL,             -- ç»Ÿè®¡æ—¥æœŸ
    stat_type TEXT NOT NULL,             -- daily/weekly/monthly
    
    -- ä½¿ç”¨æ•°æ®
    login_count INTEGER DEFAULT 0,       -- ç™»å½•æ¬¡æ•°
    active_days INTEGER DEFAULT 0,       -- æ´»è·ƒå¤©æ•°
    
    -- åŠŸèƒ½ä½¿ç”¨
    import_count INTEGER DEFAULT 0,     -- å¯¼å…¥æ¬¡æ•°
    diagnosis_count INTEGER DEFAULT 0,   -- è¯Šæ–­æ¬¡æ•°
    plan_generation_count INTEGER DEFAULT 0, -- æ–¹æ¡ˆç”Ÿæˆæ¬¡æ•°
    export_count INTEGER DEFAULT 0,      -- å¯¼å‡ºæ¬¡æ•°
    
    -- å®¢æˆ·æ•°æ®
    customer_count INTEGER DEFAULT 0,    -- å®¢æˆ·æ€»æ•°
    customer_a_count INTEGER DEFAULT 0,  -- Aç±»å®¢æˆ·æ•°
    customer_b_count INTEGER DEFAULT 0,  -- Bç±»å®¢æˆ·æ•°
    customer_c_count INTEGER DEFAULT 0,  -- Cç±»å®¢æˆ·æ•°
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(tenant_id, stat_date, stat_type),
    FOREIGN KEY (tenant_id) REFERENCES tenants(id)
);

-- ç´¢å¼•
CREATE INDEX idx_stats_tenant_id ON usage_stats(tenant_id);
CREATE INDEX idx_stats_stat_date ON usage_stats(stat_date);
CREATE INDEX idx_stats_stat_type ON usage_stats(stat_type);
```

---

## 3. æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

### 3.1 åˆå§‹åŒ–è„šæœ¬ï¼ˆinit_db.pyï¼‰

```python
#!/usr/bin/env python3
"""
æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
æ¯ä¸ªæœ‹å‹å®ä¾‹ç‹¬ç«‹è¿è¡Œï¼Œåˆ›å»ºè‡ªå·±çš„æ•°æ®åº“
"""

import sqlite3
import os
from pathlib import Path
import json
from datetime import datetime

def init_database(db_path: str, tenant_name: str):
    """åˆå§‹åŒ–æœ‹å‹æ•°æ®åº“"""
    
    # ç¡®ä¿ç›®å½•å­˜åœ¨
    os.makedirs(os.path.dirname(db_path), exist_ok=True)
    
    # è¿æ¥æ•°æ®åº“
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()
    
    print(f"åˆå§‹åŒ–æ•°æ®åº“: {db_path}")
    
    # å¯ç”¨å¤–é”®çº¦æŸ
    cursor.execute("PRAGMA foreign_keys = ON")
    
    # åˆ›å»ºè¡¨
    print("åˆ›å»ºè¡¨ç»“æ„...")
    
    # ç§Ÿæˆ·è¡¨ï¼ˆæ¯ä¸ªå®ä¾‹åªæœ‰ä¸€æ¡è®°å½•ï¼‰
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS tenants (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL UNIQUE,
        logo_path TEXT,
        primary_color TEXT DEFAULT '#1890ff',
        secondary_color TEXT DEFAULT '#52c41a',
        config_json TEXT DEFAULT '{}',
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    )
    ''')
    
    # å®¢æˆ·è¡¨
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS customers (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        tenant_id INTEGER NOT NULL,
        name TEXT NOT NULL,
        reg_capital REAL,
        established_date DATE,
        legal_person TEXT,
        annual_invoice REAL,
        annual_tax REAL,
        monthly_flow REAL,
        legal_credit TEXT,
        company_credit TEXT,
        main_business TEXT,
        industry TEXT,
        loan_demand REAL,
        collateral TEXT,
        status TEXT DEFAULT 'active',
        category TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (tenant_id) REFERENCES tenants(id)
    )
    ''')
    
    # è¯Šæ–­è®°å½•è¡¨
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS diagnosis_records (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        tenant_id INTEGER NOT NULL,
        customer_id INTEGER NOT NULL,
        flow_score INTEGER DEFAULT 0,
        invoice_tax_score INTEGER DEFAULT 0,
        credit_score INTEGER DEFAULT 0,
        asset_score INTEGER DEFAULT 0,
        qualification_score INTEGER DEFAULT 0,
        industry_score INTEGER DEFAULT 0,
        total_score INTEGER DEFAULT 0,
        category TEXT CHECK(category IN ('A', 'B', 'C')),
        diagnosis_reason TEXT,
        raw_data_json TEXT,
        manual_reviewed BOOLEAN DEFAULT FALSE,
        manual_category TEXT,
        manual_reason TEXT,
        reviewed_by TEXT,
        reviewed_at TIMESTAMP,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (tenant_id) REFERENCES tenants(id),
        FOREIGN KEY (customer_id) REFERENCES customers(id)
    )
    ''')
    
    # æ”¹é€ æ–¹æ¡ˆè¡¨
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS improvement_plans (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        tenant_id INTEGER NOT NULL,
        customer_id INTEGER NOT NULL,
        diagnosis_id INTEGER NOT NULL,
        plan_type TEXT NOT NULL,
        plan_name TEXT,
        plan_description TEXT,
        gap_list_json TEXT,
        task_list_json TEXT,
        service_providers_json TEXT,
        effect_preview_json TEXT,
        cost_estimation_json TEXT,
        status TEXT DEFAULT 'pending',
        progress_percentage INTEGER DEFAULT 0,
        started_at TIMESTAMP,
        completed_at TIMESTAMP,
        cancelled_at TIMESTAMP,
        cancelled_reason TEXT,
        reminder_enabled BOOLEAN DEFAULT TRUE,
        reminder_days INTEGER DEFAULT 90,
        last_reminded_at TIMESTAMP,
        next_remind_at TIMESTAMP,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (tenant_id) REFERENCES tenants(id),
        FOREIGN KEY (customer_id) REFERENCES customers(id),
        FOREIGN KEY (diagnosis_id) REFERENCES diagnosis_records(id)
    )
    ''')
    
    # æ“ä½œæ—¥å¿—è¡¨
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS operation_logs (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        tenant_id INTEGER NOT NULL,
        operation_type TEXT NOT NULL,
        resource_type TEXT NOT NULL,
        resource_id INTEGER,
        operator TEXT DEFAULT 'system',
        details_json TEXT,
        ip_address TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (tenant_id) REFERENCES tenants(id)
    )
    ''')
    
    # ä½¿ç”¨ç»Ÿè®¡è¡¨
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS usage_stats (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        tenant_id INTEGER NOT NULL,
        stat_date DATE NOT NULL,
        stat_type TEXT NOT NULL,
        login_count INTEGER DEFAULT 0,
        active_days INTEGER DEFAULT 0,
        import_count INTEGER DEFAULT 0,
        diagnosis_count INTEGER DEFAULT 0,
        plan_generation_count INTEGER DEFAULT 0,
        export_count INTEGER DEFAULT 0,
        customer_count INTEGER DEFAULT 0,
        customer_a_count INTEGER DEFAULT 0,
        customer_b_count INTEGER DEFAULT 0,
        customer_c_count INTEGER DEFAULT 0,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        UNIQUE(tenant_id, stat_date, stat_type),
        FOREIGN KEY (tenant_id) REFERENCES tenants(id)
    )
    ''')
    
    # åˆ›å»ºç´¢å¼•
    print("åˆ›å»ºç´¢å¼•...")
    
    # å®¢æˆ·è¡¨ç´¢å¼•
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_customers_tenant_id ON customers(tenant_id)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_customers_category ON customers(category)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_customers_created_at ON customers(created_at)')
    
    # è¯Šæ–­è®°å½•è¡¨ç´¢å¼•
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_diagnosis_tenant_id ON diagnosis_records(tenant_id)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_diagnosis_customer_id ON diagnosis_records(customer_id)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_diagnosis_category ON diagnosis_records(category)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_diagnosis_created_at ON diagnosis_records(created_at)')
    
    # æ”¹é€ æ–¹æ¡ˆè¡¨ç´¢å¼•
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_plans_tenant_id ON improvement_plans(tenant_id)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_plans_customer_id ON improvement_plans(customer_id)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_plans_diagnosis_id ON improvement_plans(diagnosis_id)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_plans_status ON improvement_plans(status)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_plans_next_remind ON improvement_plans(next_remind_at)')
    
    # æ“ä½œæ—¥å¿—è¡¨ç´¢å¼•
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_logs_tenant_id ON operation_logs(tenant_id)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_logs_operation_type ON operation_logs(operation_type)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_logs_resource_type ON operation_logs(resource_type)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_logs_created_at ON operation_logs(created_at)')
    
    # ä½¿ç”¨ç»Ÿè®¡è¡¨ç´¢å¼•
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_stats_tenant_id ON usage_stats(tenant_id)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_stats_stat_date ON usage_stats(stat_date)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_stats_stat_type ON usage_stats(stat_type)')
    
    # æ’å…¥é»˜è®¤ç§Ÿæˆ·è®°å½•
    print("æ’å…¥é»˜è®¤ç§Ÿæˆ·è®°å½•...")
    cursor.execute('''
    INSERT OR IGNORE INTO tenants (name, logo_path, primary_color, secondary_color, config_json)
    VALUES (?, ?, ?, ?, ?)
    ''', (
        tenant_name,
        '/app/data/logo.png',
        '#1890ff',
        '#52c41a',
        json.dumps({
            'reminder_enabled': True,
            'export_format': 'excel',
            'diagnosis_auto': True
        })
    ))
    
    # åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜ç”¨æˆ·ï¼ˆç®€åŒ–ç‰ˆï¼ŒV0åªæœ‰å•ä¸€ç®¡ç†å‘˜ï¼‰
    print("åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜ç”¨æˆ·...")
    # åœ¨å®é™…ä»£ç ä¸­ï¼Œè¿™é‡Œä¼šåˆ›å»ºç”¨æˆ·è¡¨å¹¶æ’å…¥é»˜è®¤ç”¨æˆ·
    # ä½†V0ç®€åŒ–ç‰ˆä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ç¡¬ç¼–ç çš„å•ä¸€ç®¡ç†å‘˜
    
    # æäº¤æ›´æ”¹
    conn.commit()
    
    # éªŒè¯è¡¨åˆ›å»º
    cursor.execute("SELECT name FROM sqlite_master WHERE type='table'")
    tables = cursor.fetchall()
    print(f"åˆ›å»ºçš„è¡¨: {[table[0] for table in tables]}")
    
    # å…³é—­è¿æ¥
    conn.close()
    
    print(f"âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ: {db_path}")
    print(f"é»˜è®¤ç§Ÿæˆ·: {tenant_name}")
    print(f"æ•°æ®åº“æ–‡ä»¶: {db_path}")

if __name__ == "__main__":
    # ä½¿ç”¨ç¤ºä¾‹
    db_path = "data/database.db"
    tenant_name = "é»˜è®¤ç§Ÿæˆ·"
    
    init_database(db_path, tenant_name)
```

### 3.2 æ•°æ®åº“è¿ç§»è„šæœ¬ï¼ˆmigration.pyï¼‰

```python
#!/usr/bin/env python3
"""
æ•°æ®åº“è¿ç§»è„šæœ¬
ç”¨äºåç»­ç‰ˆæœ¬å‡çº§æ—¶çš„æ•°æ®è¿ç§»
"""

import sqlite3
import os
from pathlib import Path

def migrate_v1_to_v2(db_path: str):
    """ä»V1è¿ç§»åˆ°V2ï¼ˆå¦‚æœéœ€è¦ï¼‰"""
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()
    
    print(f"å¼€å§‹æ•°æ®åº“è¿ç§»: {db_path}")
    
    try:
        # æ£€æŸ¥æ˜¯å¦éœ€è¦è¿ç§»
        cursor.execute("PRAGMA user_version")
        current_version = cursor.fetchone()[0]
        
        if current_version < 2:
            print(f"å½“å‰ç‰ˆæœ¬: {current_version}, å‡çº§åˆ°ç‰ˆæœ¬2...")
            
            # æ·»åŠ æ–°å­—æ®µæˆ–ä¿®æ”¹è¡¨ç»“æ„
            # ä¾‹å¦‚ï¼šæ·»åŠ æ–°å­—æ®µåˆ°customersè¡¨
            try:
                cursor.execute("ALTER TABLE customers ADD COLUMN test_field TEXT")
                print("æ·»åŠ test_fieldå­—æ®µåˆ°customersè¡¨")
            except sqlite3.OperationalError as e:
                if "duplicate column name" not in str(e):
                    raise
            
            # æ›´æ–°ç‰ˆæœ¬å·
            cursor.execute("PRAGMA user_version = 2")
            conn.commit()
            print("âœ… è¿ç§»å®Œæˆï¼Œç‰ˆæœ¬å‡çº§åˆ°2")
        else:
            print(f"å½“å‰ç‰ˆæœ¬å·²ç»æ˜¯{current_version}ï¼Œæ— éœ€è¿ç§»")
            
    except Exception as e:
        print(f"è¿ç§»å¤±è´¥: {e}")
        conn.rollback()
        raise
    finally:
        conn.close()

if __name__ == "__main__":
    # è¿ç§»æ‰€æœ‰æœ‹å‹æ•°æ®åº“
    friends_dir = Path("friends")
    
    if friends_dir.exists():
        for friend_dir in friends_dir.iterdir():
            if friend_dir.is_dir():
                db_path = friend_dir / "data" / "database.db"
                if db_path.exists():
                    print(f"\nè¿ç§»æœ‹å‹æ•°æ®åº“: {friend_dir.name}")
                    migrate_v1_to_v2(str(db_path))
    else:
        print("æœªæ‰¾åˆ°friendsç›®å½•ï¼Œè·³è¿‡è¿ç§»")
```

---

## 4. æ•°æ®å¤‡ä»½ä¸æ¢å¤

### 4.1 å¤‡ä»½è„šæœ¬ï¼ˆbackup.shï¼‰

```bash
#!/bin/bash
# æ•°æ®åº“å¤‡ä»½è„šæœ¬
# æ¯å¤©å‡Œæ™¨3ç‚¹è‡ªåŠ¨è¿è¡Œ

set -e

FRIEND_NAME="$1"
BACKUP_DIR="backups/$FRIEND_NAME"
DATE=$(date '+%Y%m%d_%H%M%S')
DB_PATH="friends/friend_$FRIEND_NAME/data/database.db"

echo "ğŸ“¦ å¼€å§‹å¤‡ä»½ $FRIEND_NAME çš„æ•°æ®åº“..."

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p "$BACKUP_DIR"

# å¤‡ä»½æ•°æ®åº“
if [ -f "$DB_PATH" ]; then
    cp "$DB_PATH" "$BACKUP_DIR/database_$DATE.db"
    echo "âœ… æ•°æ®åº“å¤‡ä»½å®Œæˆ: $BACKUP_DIR/database_$DATE.db"
else
    echo "âš ï¸ æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨: $DB_PATH"
fi

# å¤‡ä»½ä¸Šä¼ æ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰
UPLOADS_PATH="friends/friend_$FRIEND_NAME/data/uploads"
if [ -d "$UPLOADS_PATH" ]; then
    tar -czf "$BACKUP_DIR/uploads_$DATE.tar.gz" -C "$UPLOADS_PATH" .
    echo "âœ… ä¸Šä¼ æ–‡ä»¶å¤‡ä»½å®Œæˆ: $BACKUP_DIR/uploads_$DATE.tar.gz"
fi

# æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘7å¤©ï¼‰
find "$BACKUP_DIR" -name "*.db" -mtime +7 -delete
find "$BACKUP_DIR" -name "*.tar.gz" -mtime +7 -delete

echo "âœ… $FRIEND_NAME å¤‡ä»½å®Œæˆï¼"
```

### 4.2 æ¢å¤è„šæœ¬ï¼ˆrestore.shï¼‰

```bash
#!/bin/bash
# æ•°æ®åº“æ¢å¤è„šæœ¬

set -e

FRIEND_NAME="$1"
BACKUP_FILE="$2"
DB_PATH="friends/friend_$FRIEND_NAME/data/database.db"

echo "ğŸ”„ å¼€å§‹æ¢å¤ $FRIEND_NAME çš„æ•°æ®åº“..."

if [ ! -f "$BACKUP_FILE" ]; then
    echo "âŒ å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨: $BACKUP_FILE"
    exit 1
fi

# åœæ­¢æœåŠ¡ï¼ˆé¿å…æ•°æ®ä¸ä¸€è‡´ï¼‰
cd "friends/friend_$FRIEND_NAME"
docker-compose stop backend

# æ¢å¤æ•°æ®åº“
cp "$BACKUP_FILE" "$DB_PATH"
echo "âœ… æ•°æ®åº“æ¢å¤å®Œæˆ: $DB_PATH"

# å¯åŠ¨æœåŠ¡
docker-compose start backend

echo "âœ… $FRIEND_NAME æ¢å¤å®Œæˆï¼æœåŠ¡å·²é‡å¯ã€‚"
```

---

## 5. æ€§èƒ½ä¼˜åŒ–

### 5.1 ç´¢å¼•è®¾è®¡

**æ ¸å¿ƒæŸ¥è¯¢ç´¢å¼•**ï¼š
```sql
-- å®¢æˆ·åˆ—è¡¨æŸ¥è¯¢ï¼ˆæŒ‰æ—¶é—´å€’åºï¼‰
CREATE INDEX idx_customers_tenant_created ON customers(tenant_id, created_at DESC);

-- è¯Šæ–­è®°å½•æŸ¥è¯¢ï¼ˆæŒ‰å®¢æˆ·å’Œæ—¶é—´ï¼‰
CREATE INDEX idx_diagnosis_customer_created ON diagnosis_records(customer_id, created_at DESC);

-- æ–¹æ¡ˆæŸ¥è¯¢ï¼ˆæŒ‰çŠ¶æ€å’Œæé†’æ—¶é—´ï¼‰
CREATE INDEX idx_plans_status_remind ON improvement_plans(status, next_remind_at);

-- ä½¿ç”¨ç»Ÿè®¡æŸ¥è¯¢ï¼ˆæŒ‰ç§Ÿæˆ·å’Œæ—¥æœŸï¼‰
CREATE INDEX idx_stats_tenant_date ON usage_stats(tenant_id, stat_date DESC);
```

### 5.2 æŸ¥è¯¢ä¼˜åŒ–

**åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–**ï¼š
```sql
-- å®¢æˆ·åˆ—è¡¨åˆ†é¡µæŸ¥è¯¢
SELECT * FROM customers 
WHERE tenant_id = ? 
ORDER BY created_at DESC 
LIMIT ? OFFSET ?;

-- ä½¿ç”¨è¦†ç›–ç´¢å¼•
CREATE INDEX idx_customers_tenant_created_paginate 
ON customers(tenant_id, created_at DESC, id);
```

**ç»Ÿè®¡æŸ¥è¯¢ä¼˜åŒ–**ï¼š
```sql
-- æ¯æ—¥ä½¿ç”¨ç»Ÿè®¡ï¼ˆé¢„è®¡ç®—ï¼‰
INSERT INTO usage_stats (tenant_id, stat_date, stat_type, ...)
SELECT 
    tenant_id,
    DATE(created_at) as stat_date,
    'daily' as stat_type,
    COUNT(DISTINCT DATE(created_at)) as active_days,
    COUNT(*) as diagnosis_count
FROM diagnosis_records
WHERE tenant_id = ? AND DATE(created_at) = ?
GROUP BY tenant_id, DATE(created_at)
ON CONFLICT(tenant_id, stat_date, stat_type) 
DO UPDATE SET 
    diagnosis_count = excluded.diagnosis_count,
    updated_at = CURRENT_TIMESTAMP;
```

### 5.3 æ•°æ®åº“ç»´æŠ¤

**å®šæœŸæ¸…ç†**ï¼š
```sql
-- æ¸…ç†30å¤©å‰çš„æ“ä½œæ—¥å¿—
DELETE FROM operation_logs 
WHERE created_at < DATE('now', '-30 days');

-- æ¸…ç†è½¯åˆ é™¤çš„å®¢æˆ·ï¼ˆä¿ç•™90å¤©ï¼‰
UPDATE customers 
SET status = 'deleted_permanent'
WHERE status = 'deleted' 
AND updated_at < DATE('now', '-90 days');

DELETE FROM customers 
WHERE status = 'deleted_permanent';
```

**æ•°æ®åº“ä¼˜åŒ–**ï¼š
```sql
-- å®šæœŸæ‰§è¡ŒVACUUMï¼ˆæ¯æœˆä¸€æ¬¡ï¼‰
VACUUM;

-- é‡æ–°åˆ†æç»Ÿè®¡ä¿¡æ¯ï¼ˆæ¯å‘¨ä¸€æ¬¡ï¼‰
ANALYZE;
```

---

## 6. å®‰å…¨è€ƒè™‘

### 6.1 æ•°æ®å®‰å…¨

**æ–‡ä»¶æƒé™**ï¼š
```bash
# æ•°æ®åº“æ–‡ä»¶æƒé™è®¾ç½®
chmod 600 data/database.db          # åªæœ‰æ‰€æœ‰è€…å¯è¯»å†™
chmod 700 data/                     # åªæœ‰æ‰€æœ‰è€…å¯è®¿é—®
chmod 755 backups/                  # æ‰€æœ‰è€…å¯è¯»å†™ï¼Œå…¶ä»–åªè¯»
```

**å¤‡ä»½åŠ å¯†**ï¼š
```bash
# å¤‡ä»½æ—¶åŠ å¯†ï¼ˆå¯é€‰ï¼‰
openssl enc -aes-256-cbc -salt -in database.db -out database.db.enc -pass pass:your_password
```

### 6.2 è®¿é—®æ§åˆ¶

**SQLiteé…ç½®**ï¼š
```python
# è¿æ¥æ•°æ®åº“æ—¶è®¾ç½®é…ç½®
import sqlite3

conn = sqlite3.connect('data/database.db')
conn.execute("PRAGMA journal_mode = WAL")  # å†™å‰æ—¥å¿—
conn.execute("PRAGMA synchronous = NORMAL") # åŒæ­¥æ¨¡å¼
conn.execute("PRAGMA foreign_keys = ON")   # å¤–é”®çº¦æŸ
conn.execute("PRAGMA busy_timeout = 5000") # è¶…æ—¶è®¾ç½®
```

### 6.3 ç›‘æ§å‘Šè­¦

**ç£ç›˜ç©ºé—´ç›‘æ§**ï¼š
```python
import os
import sqlite3

def check_disk_space(db_path):
    """æ£€æŸ¥æ•°æ®åº“ç£ç›˜ç©ºé—´"""
    stat = os.statvfs(os.path.dirname(db_path))
    free_gb = stat.f_bavail * stat.f_frsize / 1024**3
    
    if free_gb < 1:  # å°äº1GB
        send_alert(f"ç£ç›˜ç©ºé—´ä¸è¶³: {free_gb:.2f}GB")
    
    # æ£€æŸ¥æ•°æ®åº“å¤§å°
    db_size_mb = os.path.getsize(db_path) / 1024**2
    if db_size_mb > 100:  # å¤§äº100MB
        send_alert(f"æ•°æ®åº“è¿‡å¤§: {db_size_mb:.2f}MB")
```

---

## 7. éƒ¨ç½²é…ç½®

### 7.1 æ•°æ®åº“é…ç½®ï¼ˆconfig.pyï¼‰

```python
# backend/app/config.py
import os
from pathlib import Path

class Config:
    # æ•°æ®åº“é…ç½®
    DATABASE_PATH = os.getenv('DB_PATH', 'data/database.db')
    
    # ç¡®ä¿æ•°æ®åº“ç›®å½•å­˜åœ¨
    db_dir = Path(DATABASE_PATH).parent
    db_dir.mkdir(parents=True, exist_ok=True)
    
    # SQLiteè¿æ¥å­—ç¬¦ä¸²
    SQLALCHEMY_DATABASE_URL = f"sqlite:///{DATABASE_PATH}"
    
    # è¿æ¥æ± é…ç½®
    SQLALCHEMY_ENGINE_OPTIONS = {
        "connect_args": {"check_same_thread": False},
        "pool_pre_ping": True,
        "pool_recycle": 3600,
    }
    
    # å…¶ä»–é…ç½®
    UPLOAD_FOLDER = os.getenv('UPLOAD_PATH', 'data/uploads')
    MAX_CONTENT_LENGTH = 16 * 1024 * 1024  # 16MB
    SECRET_KEY = os.getenv('SECRET_KEY', 'your-secret-key-here')
    
    # ç§Ÿæˆ·é…ç½®
    TENANT_NAME = os.getenv('APP_NAME', 'é»˜è®¤ç§Ÿæˆ·')
    BRAND_NAME = os.getenv('BRAND_NAME', 'è´·æ¬¾åŠ©æ‰‹')
    LOGO_PATH = os.getenv('LOGO_PATH', '/app/data/logo.png')
    
    # åˆ›å»ºä¸Šä¼ ç›®å½•
    upload_dir = Path(UPLOAD_FOLDER)
    upload_dir.mkdir(parents=True, exist_ok=True)

config = Config()
```

### 7.2 æ•°æ®åº“è¿æ¥ï¼ˆdatabase.pyï¼‰

```python
# backend/app/database.py
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker

from app.config import config

# åˆ›å»ºæ•°æ®åº“å¼•æ“
engine = create_engine(
    config.SQLALCHEMY_DATABASE_URL,
    connect_args={"check_same_thread": False},
    pool_pre_ping=True,
    pool_recycle=3600,
)

# åˆ›å»ºä¼šè¯å·¥å‚
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

# å£°æ˜åŸºç±»
Base = declarative_base()

def get_db():
    """è·å–æ•°æ®åº“ä¼šè¯"""
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

def init_db():
    """åˆå§‹åŒ–æ•°æ®åº“ï¼ˆåˆ›å»ºè¡¨ï¼‰"""
    Base.metadata.create_all(bind=engine)
    
def check_db_connection():
    """æ£€æŸ¥æ•°æ®åº“è¿æ¥"""
    try:
        with engine.connect() as conn:
            conn.execute("SELECT 1")
        return True
    except Exception as e:
        print(f"æ•°æ®åº“è¿æ¥å¤±è´¥: {e}")
        return False
```

---

## 8. ä½¿ç”¨ç¤ºä¾‹

### 8.1 åˆ›å»ºå®¢æˆ·è®°å½•

```python
# backend/app/services/customer_service.py
from sqlalchemy.orm import Session
from datetime import date
from app.models.customer import Customer

def create_customer(db: Session, tenant_id: int, customer_data: dict):
    """åˆ›å»ºå®¢æˆ·è®°å½•"""
    
    customer = Customer(
        tenant_id=tenant_id,
        name=customer_data['name'],
        reg_capital=customer_data.get('reg_capital'),
        established_date=customer_data.get('established_date'),
        legal_person=customer_data.get('legal_person'),
        annual_invoice=customer_data.get('annual_invoice'),
        annual_tax=customer_data.get('annual_tax'),
        monthly_flow=customer_data.get('monthly_flow'),
        legal_credit=customer_data.get('legal_credit'),
        company_credit=customer_data.get('company_credit'),
        main_business=customer_data.get('main_business'),
        industry=customer_data.get('industry'),
        loan_demand=customer_data.get('loan_demand'),
        collateral=customer_data.get('collateral'),
        status='active'
    )
    
    db.add(customer)
    db.commit()
    db.refresh(customer)
    
    # è®°å½•æ“ä½œæ—¥å¿—
    log_operation(
        db=db,
        tenant_id=tenant_id,
        operation_type='create',
        resource_type='customer',
        resource_id=customer.id,
        details=customer_data
    )
    
    return customer
```

### 8.2 æ‰§è¡Œè¯Šæ–­

```python
# backend/app/services/diagnosis_service.py
from sqlalchemy.orm import Session
from app.models.customer import Customer
from app.models.diagnosis_record import DiagnosisRecord

def diagnose_customer(db: Session, customer_id: int):
    """è¯Šæ–­å®¢æˆ·"""
    
    # è·å–å®¢æˆ·ä¿¡æ¯
    customer = db.query(Customer).filter(Customer.id == customer_id).first()
    if not customer:
        return None
    
    # è®¡ç®—å…­å®«æ ¼å¾—åˆ†
    scores = calculate_scores(customer)
    
    # è®¡ç®—æ€»åˆ†
    total_score = sum([
        scores['flow_score'],
        scores['invoice_tax_score'],
        scores['credit_score'],
        scores['asset_score'],
        scores['qualification_score'],
        scores['industry_score']
    ])
    
    # ç¡®å®šåˆ†ç±»
    if total_score >= 600:
        category = 'A'
    elif total_score >= 400:
        category = 'B'
    else:
        category = 'C'
    
    # ä¸€ç¥¨å¦å†³é¡¹æ£€æŸ¥
    if customer.legal_credit == 'M3+é€¾æœŸ':
        category = 'C'
    
    # åˆ›å»ºè¯Šæ–­è®°å½•
    diagnosis = DiagnosisRecord(
        tenant_id=customer.tenant_id,
        customer_id=customer_id,
        flow_score=scores['flow_score'],
        invoice_tax_score=scores['invoice_tax_score'],
        credit_score=scores['credit_score'],
        asset_score=scores['asset_score'],
        qualification_score=scores['qualification_score'],
        industry_score=scores['industry_score'],
        total_score=total_score,
        category=category,
        diagnosis_reason=generate_reason(scores, category),
        raw_data_json=customer.to_dict()
    )
    
    db.add(diagnosis)
    db.commit()
    db.refresh(diagnosis)
    
    # æ›´æ–°å®¢æˆ·åˆ†ç±»
    customer.category = category
    db.commit()
    
    # è®°å½•æ“ä½œæ—¥å¿—
    log_operation(
        db=db,
        tenant_id=customer.tenant_id,
        operation_type='diagnosis',
        resource_type='customer',
        resource_id=customer_id,
        details={
            'scores': scores,
            'total_score': total_score,
            'category': category
        }
    )
    
    return diagnosis
```

---

## 9. å¸¸è§é—®é¢˜

### Q1ï¼šSQLiteèƒ½æ”¯æ’‘å¤šå°‘æ•°æ®ï¼Ÿ

**A1**ï¼š
- **å•ä¸ªæœ‹å‹**ï¼šæ”¯æŒ1000-5000ä¸ªå®¢æˆ·è®°å½•
- **è¯Šæ–­è®°å½•**ï¼šæ¯ä¸ªå®¢æˆ·å¤šæ¬¡è¯Šæ–­ï¼Œæ”¯æŒ10000+è®°å½•
- **æ–¹æ¡ˆè®°å½•**ï¼šæ¯ä¸ªå®¢æˆ·å¤šä¸ªæ–¹æ¡ˆï¼Œæ”¯æŒ5000+è®°å½•
- **æ€§èƒ½è¡¨ç°**ï¼š100æ¡æ•°æ®å¯¼å…¥<5ç§’ï¼Œè¯Šæ–­è®¡ç®—<2ç§’

### Q2ï¼šå¦‚ä½•å¤‡ä»½å’Œæ¢å¤ï¼Ÿ

**A2**ï¼š
- **è‡ªåŠ¨å¤‡ä»½**ï¼šæ¯å¤©å‡Œæ™¨3ç‚¹è‡ªåŠ¨å¤‡ä»½
- **æ‰‹åŠ¨å¤‡ä»½**ï¼šè¿è¡Œ`./scripts/backup.sh [æœ‹å‹å§“å]`
- **æ¢å¤æ•°æ®**ï¼šè¿è¡Œ`./scripts/restore.sh [æœ‹å‹å§“å] [å¤‡ä»½æ–‡ä»¶]`
- **ä¿ç•™ç­–ç•¥**ï¼šä¿ç•™æœ€è¿‘7å¤©å¤‡ä»½

### Q3ï¼šå¦‚ä½•è¿ç§»åˆ°PostgreSQLï¼Ÿ

**A3**ï¼š
å¦‚æœæœ‹å‹æ•°é‡å¢åŠ æˆ–æ•°æ®é‡å¢å¤§ï¼Œå¯ä»¥è¿ç§»åˆ°PostgreSQLï¼š

```python
# migration_sqlite_to_postgres.py
import sqlite3
import psycopg2
import json

def migrate_to_postgres(sqlite_path, postgres_url):
    """ä»SQLiteè¿ç§»åˆ°PostgreSQL"""
    
    # è¿æ¥SQLite
    sqlite_conn = sqlite3.connect(sqlite_path)
    sqlite_cursor = sqlite_conn.cursor()
    
    # è¿æ¥PostgreSQL
    postgres_conn = psycopg2.connect(postgres_url)
    postgres_cursor = postgres_conn.cursor()
    
    # è¿ç§»æ•°æ®
    tables = ['tenants', 'customers', 'diagnosis_records', 'improvement_plans', 'operation_logs', 'usage_stats']
    
    for table in tables:
        print(f"è¿ç§»è¡¨: {table}")
        
        # ä»SQLiteè¯»å–æ•°æ®
        sqlite_cursor.execute(f"SELECT * FROM {table}")
        rows = sqlite_cursor.fetchall()
        
        # è·å–åˆ—å
        sqlite_cursor.execute(f"PRAGMA table_info({table})")
        columns = [col[1] for col in sqlite_cursor.fetchall()]
        
        # æ’å…¥åˆ°PostgreSQL
        for row in rows:
            placeholders = ', '.join(['%s'] * len(row))
            column_names = ', '.join(columns)
            query = f"INSERT INTO {table} ({column_names}) VALUES ({placeholders})"
            postgres_cursor.execute(query, row)
    
    # æäº¤å’Œå…³é—­
    postgres_conn.commit()
    postgres_cursor.close()
    postgres_conn.close()
    sqlite_cursor.close()
    sqlite_conn.close()
    
    print("âœ… è¿ç§»å®Œæˆ")
```

---

---

## ğŸ“ ç‰ˆæœ¬æ›´æ–°è®°å½•

### v1.4ï¼ˆ2026-02-06ï¼‰
**é‡å¤§æ›´æ–°**ï¼šæ–°å¢ç»“æœå›å¡«è¡¨ + V1è½»å¤åˆ¶å­—æ®µ

**æ ¸å¿ƒå˜æ›´**ï¼š
1. âœ… æ–°å¢è¡¨ï¼šresult_feedbackï¼ˆç»“æœå›å¡«è¡¨ï¼‰â­â­â­â­â­
   - æ•°æ®é£è½®æ ¸å¿ƒ
   - å›å¡«ç‡<50%æ˜¯ç”Ÿæ­»çº¿
   - å…­å®«æ ¼å¼ºåˆ¶å½’å› 
   
2. âœ… tenantsè¡¨æ–°å¢å­—æ®µï¼ˆV1è½»å¤åˆ¶ï¼‰ï¼š
   - partner_idï¼ˆä¸“å±IDï¼‰
   - brand_nameï¼ˆå“ç‰Œåç§°ï¼‰
   - logo_urlï¼ˆLogoåœ°å€ï¼‰
   - contact_phone/wechat/address
   - theme_colorï¼ˆä¸»é¢˜è‰²ï¼‰
   
3. âœ… customersè¡¨æ–°å¢å­—æ®µï¼ˆV1æ¥æºè¿½è¸ªï¼‰ï¼š
   - source_partner_idï¼ˆæ¥æºä¸­ä»‹IDï¼‰
   - source_channelï¼ˆæ¥æºæ¸ é“ï¼‰
   - source_urlï¼ˆæ¥æºURLï¼‰

**V0/V1åˆ’åˆ†**ï¼š
- V0ï¼šä¸å®ç°è½»å¤åˆ¶å­—æ®µï¼ˆç»Ÿä¸€å“ç‰Œ"è´·æŸ¥æŸ¥"ï¼‰
- V1ï¼šå®ç°è½»å¤åˆ¶å­—æ®µï¼ˆpartner_idçš®è‚¤ï¼‰
- V0å¿…é¡»å®ç°ï¼šresult_feedbackè¡¨

**å½±å“èŒƒå›´**ï¼š
- å¼€å‘å›¢é˜Ÿï¼šV0å»ºè¡¨æ—¶æ–°å¢result_feedback
- äº§å“å›¢é˜Ÿï¼šæ˜ç¡®å›å¡«ç‡ç›®æ ‡ï¼ˆV0>50%, V1>80%ï¼‰

### v1.3ï¼ˆ2026-02-02ï¼‰
- è¡¥å……å®¡è®¡æ—¥å¿—è¡¨è®¾è®¡
- ä¼˜åŒ–ç´¢å¼•è®¾è®¡

### v1.0ï¼ˆ2026-01-27ï¼‰
- åˆå§‹ç‰ˆæœ¬

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.4  
**åˆ›å»ºæ—¥æœŸ**ï¼š2026-02-05  
**æœ€åæ›´æ–°**ï¼š2026-02-06  
**ç»´æŠ¤äºº**ï¼šæŠ€æœ¯å›¢é˜Ÿ  
**é€‚ç”¨é˜¶æ®µ**ï¼šV0å¼€å‘é˜¶æ®µ  
**æ•°æ®åº“å¼•æ“**ï¼šSQLiteï¼ˆæ¯ä¸ªæœ‹å‹ç‹¬ç«‹æ–‡ä»¶ï¼‰  
**åç»­å‡çº§**ï¼šV1é˜¶æ®µè€ƒè™‘è¿ç§»åˆ°PostgreSQL